import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintStream;
import java.util.ArrayList;

import openSaveControl.OpenSaveControlClient;

public class TraOpenSaveControlClient implements OpenSaveControlClient {

  TeacherReportAssistant tra;

  public TraOpenSaveControlClient(TeacherReportAssistant tra) {
    this.tra = tra;
  }

  // Open Directory.
  public void openReadFile(File dirFile) {
    // Read 2 input data files
	  
	  BufferedReader br=null;

    String[] fileNames = { "names.tra",  "sentenceTemplates.tra" };
    ArrayList<Student> students = new ArrayList<Student>();
    //Map<String, GenderWordPair> genderWordsDict = new HashMap<String, GenderWordPair>();
    Templates templates = new Templates();
    TemplateCategory tc = new TemplateCategory();
    String pathSeparator = System.getProperty("file.separator"); 

    // Loop once to read each data file in the directory
    for (int f = 0; f < fileNames.length; f++) {
      try {

        String fullFileName = dirFile.getAbsolutePath() + pathSeparator + fileNames[f];
        

        // Check to make sure the file exists.
        File file = new File(fullFileName);
           if (!file.exists() || file.isDirectory() ) {
           	
           }
        
        FileInputStream fstream = new FileInputStream(fullFileName);
        
        
        
        br = new BufferedReader(new InputStreamReader(fstream));
        
        

        String strLine;

        // Read File Line By Line
        while ((strLine = br.readLine()) != null) {
          strLine = strLine.trim();

          // check for a comment or empty line
          if (strLine.length() == 0)
            continue;
          if (strLine.substring(0, 1).equals("#"))
            continue;

          if (f == 0) {

            // Split line into gender and name.
            String[] parsed = strLine.split(" ", 2);

            // Make sure Gender is uppercase
            parsed[0] = parsed[0].toUpperCase();

            if (!parsed[0].equals("M") && !parsed[0].equals("F")) {
              throw new Exception("Invalid Gender in " + fullFileName
                  + ". Line is \"" + strLine + "\"");
            }

            Student s = new Student(parsed[0], parsed[1]);
            students.add(s);
          } else if (f == 1) {
            // Does strLine identifies a new category?
            if (strLine.substring(0, 1).equals("\"")) {

              // strLine identifies a new category
              if (!tc.empty())
                templates.add(tc);
              tc = new TemplateCategory(strLine.substring(1));
            } else {
              // strLine is another template line
              tc.addTemplate(strLine);
            }
          }

        }
        br.close();
        br=null;
        if (f == 0)
          tra.setStudents(students);
        else if (f == 1){
          if (!tc.empty())
            templates.add(tc);
          tra.setTemplates(templates);
        }
      }

      catch (Exception e) {
        System.err.println(e.getMessage());
      }
      finally {
    	  if ( br!= null )
			try {
				br.close();
			} catch (IOException e) {
				e.printStackTrace();
			} 
      }
    }
    
    /*
    tra.getContentPane().remove(tra.getPanelWithTabs());
    ContentPanel contentPanel = new ContentPanel(tra);
    tra.setPanelWithTabs(contentPanel);
    tra.getContentPane().add(contentPanel);
    tra.invalidate();
    tra.validate();
    */
    ContentPanelWDesigner cp = new ContentPanelWDesigner(tra);
    tra.setContentPanel(cp);
    
    // Test
    
//    JFrame jf = new JFrame();
//    jf.setContentPane(new ContentPanel(tra));
//    jf.setTitle("Test New Main Window from TRA Open Control");
//    jf.setSize(800, 480);
//    jf.setVisible(true);
    
    
    

    // update label on GUI to have name of first student
    //studentsIndex=-1;
    tra.advanceToNextStudent(); 
    
  
  }
  
  public void writeFile(File f) {

    //BufferedWriter out = null;
    PrintStream fileStream = null;
    try  
    {
      fileStream = new PrintStream(f);
      String reportAsString = tra.getReports();
      String [] split = reportAsString.split("\n");
      for (String s:split) {
        System.out.println(s);
        fileStream.println(s);
      }

      
      //fileStream.println(reportAsString);
       // FileWriter out = new FileWriter(f); 
       // out = new BufferedWriter(out);
        //out.write(reportAsString);
    }
    catch (IOException e)
    {
        System.err.println("Error: " + e.getMessage());
        e.printStackTrace();
    }
    finally
    {
        if(fileStream != null) {
            try {
              fileStream.close();
            }
            catch (Exception e) {
              System.err.println("Error: " + e.getMessage());
              e.printStackTrace();
            }
        }
    }
    
  }
  
  // Enable/Disable File menu bar items
  public void enableSaveMenuItem(Boolean b) {
    tra.getTraMenuBar().enableSaveMenuItem(b);
  }
  public void enableSaveAsMenuItem(Boolean b)  {
    tra.getTraMenuBar().enableSaveAsMenuItem(b);
  }
  
}
